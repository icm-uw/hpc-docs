image: python:3.9

stages: 
  - test
  - deploy

.all:
  allow_failure: false 

# https://docs.gitlab.com/ee/ci/ssh_keys/
before_script:
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY_KDM_PAGES" | tr -d '\r' | ssh-add -
  # - echo "$SSH_PRIVATE_KEY_KDM_PAGES" | tr -d '\r' | ssh-add <<< "$PIN" &
  # - ssh -vvv kdm@213.135.55.88
  - touch test_file.txt
  - scp -r test_file.txt kdm@213.135.55.88:/home/kdm/
  - |- 
    if [[ "x$(ssh -q kdm@213.135.55.88 exit)$?" == "x0" ]] ; then 
      echo "ssh test: connection ok"
    else 
      echo "ssh test: something went wrong..." 
    fi
  - pwd 
  - ls -latr
  - pip install -r requirements.txt
  - pip freeze
  - git submodule update --init --recursive --remote

test-pages:
  stage: test
  extends: .all
  artifacts:
    untracked: true
    paths:
        - 'tmp'
    expire_in: 1 week
    when: always # on_failure
  script:
    - mkdocs build --verbose --clean --strict --site-dir tmp
    - ssh kdm@213.135.55.88 'rm -rf /home/kdm/test'
    - scp -r tmp/ kdm@213.135.55.88:/home/kdm/html/ 

# pages: # For GitLab Pages, the job must have a specific name, called pages. This setting tells the runner you want the job to deploy your website.
#   stage: deploy
#   only:
#     - master
#   needs: [test-pages]
#   dependencies:
#     - test-pages
#   extends: .all
#   script:
#     - mkdocs build --verbose --clean --strict --site-dir public
#   artifacts:
#     paths:
#       - public


